# Andastra.NET AI Agent Rules (2026 Edition)

You are an AI agent contributing to Andastra.NET, a .NET project for reverse-engineering and modding Knights of the Old Republic games. Your highest priority is **repository integrity, conflict avoidance in multi-agent workflows, and strict git discipline**. Follow every rule below exactly. Never skip or batch commits.

## 1. MANDATORY: Git Commit Discipline (Highest Priority – Non-Negotiable)

In multi-agent environments, conflicts arise quickly. To prevent them:

- **NEVER** use `git add .`, `git add -A`, or any wildcard/all-files command.
- **ALWAYS** add and commit **one file at a time** (or a small logical group of tightly related files in one chained command).
- **ALWAYS** chain `git add` and `git commit` on the **same line** using platform-appropriate separators to ensure atomic execution.

**Commits**

- Use exact chained format: `git add <file1> <file2>; git commit -m "type(scope): message"` (Windows) **or** `git add <file1> <file2> && git commit -m "type(scope): message"` (Unix/Mac).
- Only list modified/created/deleted/moved file(s) (no wildcards).
- Commit messages MUST follow conventional commits (`type(optional scope): message`)
  - Valid types: `feat:`, `fix:`, `refactor:`, `docs:`, `chore:`, `test:`
  - Keep messages concise, lowercase, and descriptive.
- Let pre-commit hooks run fully.
- Limit to 2–3 commands per clean commit.

**General**

- Append `--no-pager` to paging commands.
- Preserve working-tree changes.
- Snapshot before cleanups (e.g., `git stash push --include-untracked`).
- Get explicit user approval before destructive actions, quoting the command.

### Exact Command Formats (MUST USE ONE OF THESE)

| Platform | Command Format                                                                 |
|----------|--------------------------------------------------------------------------------|
| Windows  | `git add <file1> <file2>; git commit -m "type(scope): message"`                |
| Unix/Mac | `git add <file1> <file2> && git commit -m "type(scope): message"`             |

### CORRECT EXAMPLES

```powershell
git add Src/CameraSystem.cs; git commit -m "feat(K2-camera): add camera rotation logic"
```

```bash
git add Src/Utils/MathHelper.cs Src/Utils/Vector.cs && git commit -m "refactor(math): simplify vector operations"
```

#### INCORRECT EXAMPLES (NEVER USE)

```powershell
git add .                  # Wrong: adds everything
git add -A                 # Wrong: adds everything
git add file.cs            # Wrong: missing commit
git commit -m "..."        # Wrong: without prior add in chain
git add file.md; git commit -m "Update file.md"  # Wrong: non-conventional message
```

### MANDATORY RESPONSE BEHAVIOR

- After **any** file change or set of related changes, **YOU MUST** end your response with a fenced code block titled "Proposed Git Commands" containing the **exact** chained command(s) ready to copy-paste.
- Then add exactly this confirmation line: `Git commits: Issued per rules ✅`
- If no changes were made, state: `Git commits: No changes made ✅`

Example response ending:

```powershell
git add Src/CameraSystem.cs; git commit -m "feat(K2-camera): implement freelook mode"
```

Git commits: Issued per rules ✅

This step is never optional. It ensures atomic commits and proves rule adherence.

## 2. File Organization

Keep root clean. Allowed root files only: `README.md`, `.sln`, `.csproj`, `.props`, `.gitignore`, `.cursor/rules`.

- Place all `.md` (except root `README.md`) in `docs/`
- Place all scripts (`.ps1`, `.sh`, `.py`, `.bat`) in `scripts/`

Move misplaced files immediately and commit.

## 3. .NET Target Frameworks

Target only cross-platform frameworks.

- Primary: `net9.0`
- Platform-specific: Use conditional equivalents (e.g., `net9.0-windows` with checks for Linux/macOS)

## 4. C# Language Version

Limit to C# 7.3 maximum. Ban C# 8+ features.

Rewrite prohibited constructs:

| Feature              | Replacement Pattern                                      |
|----------------------|----------------------------------------------------------|
| Nullable refs (`string?`) | Use `string` + `[CanBeNull]` attribute                  |
| Disposable using decl | Use explicit blocks: `using (var x = ...) { }`          |
| Switch expressions   | Use traditional switch statements                        |

### JetBrains.Annotations for Nullability

| Annotation   | Usage Example                                            |
|--------------|----------------------------------------------------------|
| `[CanBeNull]`| Marks return/parameter that may be null                   |
| `[NotNull]`  | Marks parameter that must not be null                     |

Example:

```csharp
[CanBeNull]
public string GetContent([NotNull] int index, [CanBeNull] object something = null)
{
    // logic
}
```

## 5. MANDATORY: Incomplete Code Policy (High Priority – Non-Negotiable)
Large reverse-engineering tasks may require multiple passes, but **NEVER** leave unmarked stubs, placeholders, or incomplete implementations. Visibility is critical.

- **PREFER AND AIM FOR**: Fully complete, production-ready code in every change. Implement the requested feature/mechanic fully.
- **IF ANY CODE IS INCOMPLETE** (e.g., due to task size or missing info): **YOU MUST** mark it explicitly with `// TODO:` using the exact types below. Never use vague comments like "real implementation needed" without TODO.
- **NEVER** write placeholder logic (e.g., `return false; // actual later`, empty methods, dummy data) without a TODO comment.
- **PROHIBITED PHRASES** (without accompanying `// TODO:`):
  - "real implementation"
  - "actual implementation"
  - "this is a placeholder"
  - "would require"
  - "stub"
  - "temporary"
  - "TBD"
  - empty method bodies without comment

**Exact TODO Format (MUST FOLLOW)**

Always mark unfinished code with `// TODO:` + type + context.

| Type         | Usage Pattern                                            | Example |
|--------------|----------------------------------------------------------|---------|
| STUB        | Missing implementation (e.g., engine function)           | `// TODO: STUB - Implement K2 event system (swkotor2.exe: 0x004eb750)` |
| PLACEHOLDER | Temporary data/structure                                 | `// TODO: PLACEHOLDER - Replace with actual resource loading` |
| FIXME       | Known issue (e.g., leak)                                 | `// TODO: FIXME - Memory leak in model unloading` |
| SIMPLIFIED  | Reduced fidelity (e.g., no optimization)                 | `// TODO: SIMPLIFIED - Full animation blending not implemented` |
| HACK        | Workaround (e.g., reflection)                            | `// TODO: HACK - Reflection workaround until API fixed` |

**CORRECT EXAMPLES**
```csharp
// TODO: STUB - Full parsing of K1 MDL binary header (reference needed)
public void ParseHeader() { }

// TODO: HACK - Force cast until proper interface added
var model = (Model)obj;
```

**INCORRECT EXAMPLES (NEVER USE)**
```csharp
// real implementation needed
public void ParseHeader() { return; }

// Placeholder for now
int value = 0;

// Simplified implementation - a full implementation would require:
// - Loading the resource
// - Parsing the resource
// - Returning the resource
public void ParseHeader() { return; }
```

**MANDATORY RESPONSE BEHAVIOR**
- After any code change, **YOU MUST** end your response with a fenced block summarizing completeness:
  - If fully complete: "Implementation status: Complete – No incomplete code or TODOs added ✅"
  - If TODOs added: List them explicitly:
```
New TODOs introduced:
- File.cs: Line 123 // TODO: STUB - ...
- File2.cs: Line 45 // TODO: FIXME - ...
```

Implementation status: Incomplete sections marked per rules ⚠️
```
- This proves adherence and gives immediate visibility (searchable in chat/history).

## 6. Architecture Preferences

For new code: Prefer conditional logic over inheritance.

```csharp
if (GameType == GameType.K1) { /* K1 behavior */ }
else if (GameType == GameType.K2) { /* K2 TSL behavior */ }
```

Leave existing inheritance unchanged. Never refactor it.

## 7. Reverse Engineering Workflow

Follow this mandatory sequence:

1. Analyze in Ghidra first.
2. Document: Rename functions/variables, add comments/prototypes.
3. In C#: Add source comment.

   ```csharp
   // swkotor2.exe: 0x004eb750 – original engine behavior
   ```

4. Verify 1:1 parity with REVA MCP tools on project "C:\Users\boden\Andastra Ghidra Project.gpr".

**Critical**: If REVA setup or tool fails (connection/error/unavailable), stop immediately and inform user.

## 8. NSS/NCS Operations

Use only `scripts/NcsTool.ps1` for compile, decompile, compare, roundtrip, generate-defs.

## 9. Documentation

- Public-facing `.md`: Place in `docs/`
- Progress roadmaps: Place in `.cursor/roadmaps/*.md`
- All other documentation: Use roadmaps or public docs only

## 10. Definition of Done

Verify all items before completion:

- Code compiles without warnings
- Uses only C# 7.3 features
- Matches original engine behavior (Ghidra-verified)
- All changes committed
- Files in correct locations
- Unfinished parts marked with `TODO: <type> <context>`

Adhere exactly to ensure project integrity and cross-platform compatibility.

**Key Citations**
- [PromptingGuide.ai (2026)](https://www.promptingguide.ai/)
- [Lakera Ultimate Guide to Prompt Engineering (2025)](https://www.lakera.ai/blog/prompt-engineering-guide)
- [IBM 2026 Guide to Prompt Engineering](https://www.ibm.com/think/prompt-engineering)
- [Agents At Work: 2026 Playbook](https://promptengineering.org/agents-at-work-the-2026-playbook-for-building-reliable-agentic-workflows/)
- [UiPath 10 Best Practices for AI Agents (2025)](https://www.uipath.com/blog/ai/agent-builder-best-practices)
- [GitHub Lessons from 2500+ agents.md (2025)](https://github.blog/ai-and-ml/github-copilot/how-to-write-a-great-agents-md-lessons-from-over-2500-repositories/)
- [Medium Ultimate Technical Guide (2026)](https://medium.com/@ganeshvenkatsubramaniyan/the-ultimate-technical-guide-to-prompt-engineering-in-2026-e4ef8cb61f10)
- [Portkey Token Efficiency (2025)](https://portkey.ai/blog/optimize-token-efficiency-in-prompts)
- [Agentic Coding GitHub Repo](https://github.com/sammcj/agentic-coding)
- [OpenAI Prompt Engineering Guide (2026 Updates)](https://platform.openai.com/docs/guides/prompt-engineering)
