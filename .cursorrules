# Andastra.NET AI Agent Rules (2026 Edition)

You are an AI agent contributing to Andastra.NET, a .NET project for reverse-engineering and modding Knights of the Old Republic games. Adhere strictly to these rules for consistency, compatibility, and engine fidelity.

## 1. Git Commits (Non-Negotiable)

Commit every file change (create, modify, delete, move) immediately.

Use conventional commits with optional scope:

- Types: `fix:`, `feat:`, `refactor:`, `docs:`, `chore:`, `test:`
- Never use `git add .` or `-A`

| Platform  | Command Format                                      |
|-----------|-----------------------------------------------------|
| Windows   | `git add <file>; git commit -m "type(scope): message"` |
| Unix      | `git add <file> && git commit -m "type(scope): message"` |

Example: `feat(K2-camera): add camera system`

## 2. File Organization

Keep root clean. Allowed root files only: `README.md`, `.sln`, `.csproj`, `.props`, `.gitignore`, `.cursor/rules`.

- Place all `.md` (except root `README.md`) in `docs/`
- Place all scripts (`.ps1`, `.sh`, `.py`, `.bat`) in `scripts/`

Move misplaced files immediately and commit.

## 3. .NET Target Frameworks

Target only cross-platform frameworks.

- Primary: `net9.0`
- Platform-specific: Use conditional equivalents (e.g., `net9.0-windows` with checks for Linux/macOS)

## 4. C# Language Version

Limit to C# 7.3 maximum. Ban C# 8+ features.

Rewrite prohibited constructs:

| Feature              | Replacement Pattern                                      |
|----------------------|----------------------------------------------------------|
| Nullable refs (`string?`) | Use `string` + `[CanBeNull]` attribute                  |
| Disposable using decl | Use explicit blocks: `using (var x = ...) { }`          |
| Switch expressions   | Use traditional switch statements                        |

### JetBrains.Annotations for Nullability

| Annotation   | Usage Example                                            |
|--------------|----------------------------------------------------------|
| `[CanBeNull]`| Marks return/parameter that may be null                   |
| `[NotNull]`  | Marks parameter that must not be null                     |

Example:

```csharp
[CanBeNull]
public string GetContent([NotNull] int index, [CanBeNull] object something = null)
{
    // logic
}
```

## 5. Incomplete Code Marking

Always mark unfinished code with `// TODO:` + type + context.

| Type         | Usage Pattern                                            |
|--------------|----------------------------------------------------------|
| STUB        | Missing implementation (e.g., engine function)           |
| PLACEHOLDER | Temporary data/structure                                 |
| FIXME       | Known issue (e.g., leak)                                 |
| SIMPLIFIED  | Reduced fidelity (e.g., no optimization)                 |
| HACK        | Workaround (e.g., reflection)                            |

Examples:

```csharp
// TODO: STUB - Implement K2 event system (swkotor2.exe: 0x004eb750)
// TODO: HACK - Reflection workaround until API fixed
```

## 6. Architecture Preferences

For new code: Prefer conditional logic over inheritance.

```csharp
if (GameType == GameType.K1) { /* K1 behavior */ }
else if (GameType == GameType.K2) { /* K2 TSL behavior */ }
```

Leave existing inheritance unchanged. Never refactor it.

## 7. Reverse Engineering Workflow

Follow this mandatory sequence:

1. Analyze in Ghidra first.
2. Document: Rename functions/variables, add comments/prototypes.
3. In C#: Add source comment.

   ```csharp
   // swkotor2.exe: 0x004eb750 â€“ original engine behavior
   ```

4. Verify 1:1 parity with REVA MCP tools on project "C:\Users\boden\Andastra Ghidra Project.gpr".

**Critical**: If REVA setup or tool fails (connection/error/unavailable), stop immediately and inform user.

## 8. NSS/NCS Operations

Use only `scripts/NcsTool.ps1` for compile, decompile, compare, roundtrip, generate-defs.

## 9. Documentation

- Public-facing `.md`: Place in `docs/`
- Progress roadmaps: Place in `.cursor/roadmaps/*.md`
- All other documentation: Use roadmaps or public docs only

## 10. Definition of Done

Verify all items before completion:

- Code compiles without warnings
- Uses only C# 7.3 features
- Matches original engine behavior (Ghidra-verified)
- All changes committed
- Files in correct locations
- Unfinished parts marked with `TODO: <type> <context>`

Adhere exactly to ensure project integrity and cross-platform compatibility.

**Key Citations**
- [PromptingGuide.ai (2026)](https://www.promptingguide.ai/)
- [Lakera Ultimate Guide to Prompt Engineering (2025)](https://www.lakera.ai/blog/prompt-engineering-guide)
- [IBM 2026 Guide to Prompt Engineering](https://www.ibm.com/think/prompt-engineering)
- [Agents At Work: 2026 Playbook](https://promptengineering.org/agents-at-work-the-2026-playbook-for-building-reliable-agentic-workflows/)
- [UiPath 10 Best Practices for AI Agents (2025)](https://www.uipath.com/blog/ai/agent-builder-best-practices)
- [GitHub Lessons from 2500+ agents.md (2025)](https://github.blog/ai-and-ml/github-copilot/how-to-write-a-great-agents-md-lessons-from-over-2500-repositories/)
- [Medium Ultimate Technical Guide (2026)](https://medium.com/@ganeshvenkatsubramaniyan/the-ultimate-technical-guide-to-prompt-engineering-in-2026-e4ef8cb61f10)
- [Portkey Token Efficiency (2025)](https://portkey.ai/blog/optimize-token-efficiency-in-prompts)
- [Agentic Coding GitHub Repo](https://github.com/sammcj/agentic-coding)
- [OpenAI Prompt Engineering Guide (2026 Updates)](https://platform.openai.com/docs/guides/prompt-engineering)
